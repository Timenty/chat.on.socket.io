# Документация пользовательского потока

## Процесс аутентификации

### Начальное подключение
1. Сокет-подключение устанавливается автоматически при загрузке приложения
   - `socketStore` инициализирует подключение к 'localhost:3000'
   - Проверяет наличие существующего токена в localStorage

### Аутентификация пользователя
1. Пользователь вводит имя пользователя
   - Вызывается `setUserName(userName)` из socketStore
   - Запускает внутренний процесс `authenticate(userData)`
   - Отправляет событие 'authenticate' на сервер
2. При успешной аутентификации:
   - Сохраняет токен в localStorage
   - Обновляет данные пользователя через `userStore.setUserData()`
   - Присоединяется к комнате по умолчанию через `socket.emit('joinRoom')`

### Выход из системы
- Вызывается через `socketStore.logout()`
  - Удаляет токен из localStorage
  - Сбрасывает хранилище пользователя через `userStore.reset()`
  - Очищает текущие данные пользователя

## Процесс чата

### Управление сообщениями
1. Отправка сообщений
   - `sendMessage(msg)` в socketStore обрабатывает как приватные, так и публичные сообщения
   - Для приватных сообщений:
     - Отправляет событие 'privateMessage'
     - Добавляет сообщение в локальный чат через `chat.pushMessage()`
   - Для публичных сообщений:
     - Отправляет событие 'chatMessage'
     - Добавляет сообщение в локальный чат

2. Получение сообщений
   - Прослушивает события 'message' и 'privateMessage'
   - Обрабатывает сообщения через `chat.pushMessage()`
   - Обновляет интерфейс чата новыми сообщениями

### История чата
1. Загрузка истории чата
   - `socketStore.requestChatHistory(contactTag)` запрашивает историю чата
   - Сервер отвечает событиями 'messageHistory' или 'privateChatHistory'
   - История обрабатывается через `chat.initializeChat()` или `chat.handleChatHistory()`

2. Переключение между чатами
   - `chat.switchToChat(contactTag)` меняет активный чат
   - Создает новый чат, если он не существует
   - Обновляет интерфейс для отображения выбранного чата

### Системные сообщения
- `chat.log(text, type)` обрабатывает системные сообщения
  - Типы: 'info', 'error', 'success'
  - Автоматически добавляются в текущий активный чат

## Управление контактами

### Операции с контактами
1. Добавление контактов
   - `contacts.addContact(contactTag)` инициирует запрос на добавление контакта
   - Отправляет событие 'addContact' на сервер

2. Управление списком контактов
   - `contacts.getContacts()` запрашивает текущий список контактов
   - Сервер отвечает событием 'contactsList'
   - Обновляет локальный список контактов через `contacts.updateContacts()`

### Обработка запросов контактов
1. Входящие запросы
   - Прослушивает события 'contactRequest'
   - Добавляет в ожидающие запросы через `contacts.addPendingRequest()`
   - Обновляет интерфейс для отображения ожидающих запросов

2. Обновления контактов
   - Прослушивает событие 'contactsUpdated'
   - Автоматически обновляет список контактов
   - Отражает изменения в интерфейсе

## Обработка ошибок
- Ошибки подключения сокета обрабатываются автоматически
- Ошибки сообщений логируются через `chat.log(error, 'error')`
- Ошибки, связанные с контактами, логируются в консоль
- Ошибки аутентификации отображаются через систему чата

## Обработка переподключения
- Автоматические попытки переподключения при разрыве соединения
- При успешном переподключении:
  - Логирует переподключение через систему чата
  - Повторно аутентифицирует при необходимости
  - Восстанавливает предыдущее состояние сессии
